<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Commuter Configuration</title>
    <!-- HTML in your document's head -->
    <link rel="preconnect" href="https://rsms.me/">
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">


    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* CSS */
        :root {
        font-family: Inter, sans-serif;
        font-feature-settings: 'liga' 1, 'calt' 1; /* fix for Chrome */
        }
        @supports (font-variation-settings: normal) {
        :root { font-family: InterVariable, sans-serif; }
        }

        body {
            background: #e8e8e8;
            padding: 0 0 100px 0;
            margin: 0;
            font-size: 16px;
            line-height: 1.2;
            -webkit-font-smoothing: antialiased;
        }

        button {
            font-family: inherit;
        }

        .container {
            max-width: 428px;
            margin: 0 auto;
            padding: 0px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Header Card */
        .header-card {
            background: #0055ff;
            border-radius: 20px;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-right: 0;
        }

        .header-title {
            font-size: 32px;
            font-weight: 600;
            color: white;
            line-height: 32px;
        }

        .header-icon {
            width: 123px;
            height: 32px;
        }

        /* White Cards */
        .card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: black;
        }

        .card-description {
            font-size: 16px;
            font-weight: 500;
            color: rgba(0, 0, 0, 0.35);
            line-height: 1.2;
        }

        .card-divider {
            height: 1px;
            background: rgba(0, 0, 0, 0.1);
            width: 100%;
        }

        /* Station List */
        .station-slots {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .station-slot {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .station-slot:active {
            opacity: 0.7;
        }

        .station-badge {
            background: rgba(0, 0, 0, 0.1);
            width: 19px;
            height: 19px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .station-badge-number {
            font-size: 12px;
            font-weight: 600;
            color: black;
            line-height: 16px;
            font-feature-settings: "tnum";
        }

        .station-name {
            flex: 1;
            font-size: 16px;
            font-weight: 500;
            color: black;
            line-height: 1.2;
        }

        .station-name.placeholder {
            color: rgba(0, 0, 0, 0.25);
        }

        .station-remove {
            font-size: 16px;
            font-weight: 500;
            color: #ff0707;
            cursor: pointer;
            padding: 0 5px;
        }

        /* Schedule List */
        .schedule-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .schedule-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .schedule-item:active {
            opacity: 0.7;
        }

        .schedule-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex: 1;
        }

        .schedule-meta {
            font-size: 16px;
            font-weight: 500;
            color: rgba(0, 0, 0, 0.35);
            line-height: 1.2;
        }

        .schedule-route {
            font-size: 16px;
            font-weight: 600;
            color: black;
            line-height: 1.2;
        }

        .schedule-remove {
            font-size: 16px;
            font-weight: 500;
            color: #ff0707;
            cursor: pointer;
            padding: 0 5px;
        }

        .create-route-btn {
            font-size: 16px;
            font-weight: 500;
            color: #0055ff;
            background: none;
            border: none;
            cursor: pointer;
            text-align: left;
            padding: 0;
        }

        .create-route-btn:active {
            opacity: 0.7;
        }

        /* About Section */
        .about-link {
            font-size: 16px;
            font-weight: 500;
            color: #0055ff;
            text-decoration: none;
            display: inline-block;
        }

        .about-muted-link {
            font-size: 16px;
            font-weight: 500;
            color: #0055ffa8;
            text-decoration: none;
            display: inline-block;
        }

        /* Save Button (Fixed) */
        .save-button-container {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 428px;
            padding: 0px;
            pointer-events: none;
        }

        .save-button {
            background: #52d694;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 20px;
            font-size: 24px;
            font-weight: 600;
            line-height: 24px;
            width: 100%;
            cursor: pointer;
            pointer-events: all;
            transition: transform 0.2s;
        }

        .save-button:active {
            transform: scale(0.98);
        }

        /* Bottom Sheet Drawer */
        .drawer-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .drawer-overlay.active {
            display: block;
            opacity: 1;
        }

        .drawer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 20px 20px 0 0;
            max-height: 80vh;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 1001;
            display: flex;
            flex-direction: column;
        }

        .drawer.active {
            transform: translateY(0);
        }

        .drawer-header {
            padding: 12px 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }

        .drawer-title {
            font-size: 20px;
            font-weight: 600;
            color: black;
        }

        .drawer-content {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        /* Station Search Drawer */
        .search-box {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(0, 0, 0, 0.15);
            border-radius: 12px;
            font-size: 16px;
            font-family: 'Inter', sans-serif;
            margin-bottom: 16px;
        }

        .search-box:focus {
            outline: none;
            border-color: #0055ff;
        }

        .station-search-list {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .station-search-item {
            padding: 16px 0px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: black;
            transition: background 0.15s;
        }

        .station-search-item:active {
            background: rgba(0, 85, 255, 0.08);
        }

        .station-search-item.disabled {
            color: rgba(0, 0, 0, 0.25);
            cursor: not-allowed;
        }

        .station-search-item.disabled:active {
            background: transparent;
        }

        .no-results {
            text-align: center;
            padding: 40px 20px;
            color: rgba(0, 0, 0, 0.35);
            font-size: 15px;
        }

        /* Schedule Form Drawer */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: black;
            margin-bottom: 8px;
        }

        select, input[type="time"] {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(0, 0, 0, 0.15);
            border-radius: 12px;
            font-size: 16px;
            font-family: 'Inter', sans-serif;
            background: white;
        }

        select:focus, input[type="time"]:focus {
            outline: none;
            border-color: #0055ff;
        }

        .day-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .day-btn {
            flex: 1;
            min-width: 45px;
            padding: 10px 8px;
            border: 2px solid rgba(0, 0, 0, 0.15);
            background: white;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            color: black;
            cursor: pointer;
            transition: all 0.2s;
        }

        .day-btn.active {
            background: #0055ff;
            color: white;
            border-color: #0055ff;
        }

        .form-error {
            color: #ff0707;
            font-size: 13px;
            margin-top: 6px;
            display: none;
        }

        .form-error.show {
            display: block;
        }

        .form-group.error select,
        .form-group.error input {
            border-color: #ff0707;
        }

        .drawer-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn-secondary {
            flex: 1;
            padding: 14px;
            border: 2px solid rgba(0, 0, 0, 0.15);
            background: white;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            color: black;
            cursor: pointer;
        }

        .btn-primary {
            flex: 2;
            padding: 14px;
            border: none;
            background: #0055ff;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            cursor: pointer;
        }

        .btn-primary:active, .btn-secondary:active {
            opacity: 0.8;
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 14px 24px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 500;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease;
            max-width: 90%;
            text-align: center;
        }

        .toast.show {
            opacity: 1;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 20px;
            color: rgba(0, 0, 0, 0.35);
            font-size: 15px;
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Main Container -->
    <div class="container">
        <!-- Header -->
        <div class="header-card">
            <div class="header-title">Commuter</div>
            <div class="header-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="124" height="33" viewBox="0 0 124 33" fill="none">
  <path d="M1.55859 21.4456L8.0387 1.51306H129.402V31.4528H1.55859V21.4456Z" fill="white" style="fill:white;fill-opacity:1;"/>
  <line x1="1.57693" y1="21.3974" x2="8.53214" y2="0.52573" stroke="black" style="stroke:black;stroke-opacity:1;" stroke-width="3"/>
  <line x1="24.5769" y1="21.3974" x2="31.5321" y2="0.52573" stroke="black" style="stroke:black;stroke-opacity:1;" stroke-width="3"/>
  <line x1="30.6006" y1="19.8839" x2="35.3428" y2="5.65327" stroke="black" style="stroke:black;stroke-opacity:1;" stroke-width="2"/>
  <line x1="40.4822" y1="20.5846" x2="40.4822" y2="5.5846" stroke="black" style="stroke:black;stroke-opacity:1;" stroke-width="2"/>
  <line x1="70.2822" y1="20.9694" x2="70.2822" y2="5.96936" stroke="black" style="stroke:black;stroke-opacity:1;" stroke-width="2"/>
  <line x1="45.3301" y1="32.6478" x2="45.3301" y2="5.17861" stroke="black" style="stroke:black;stroke-opacity:1;" stroke-width="2"/>
  <line x1="65.6775" y1="32.6478" x2="65.6775" y2="5.17861" stroke="black" style="stroke:black;stroke-opacity:1;" stroke-width="2"/>
  <line x1="55.4001" y1="32.6478" x2="55.4001" y2="5.17861" stroke="black" style="stroke:black;stroke-opacity:1;" stroke-width="2"/>
  <line x1="41.4822" y1="6.17859" x2="34.3882" y2="6.17859" stroke="black" style="stroke:black;stroke-opacity:1;" stroke-width="2"/>
  <line x1="123.39" y1="6.17859" x2="69.2823" y2="6.17859" stroke="black" style="stroke:black;stroke-opacity:1;" stroke-width="2"/>
  <line x1="65.7988" y1="6.17859" x2="46.33" y2="6.17859" stroke="black" style="stroke:black;stroke-opacity:1;" stroke-width="2"/>
  <line x1="41.4822" y1="20.3553" x2="29.7135" y2="20.3553" stroke="black" style="stroke:black;stroke-opacity:1;" stroke-width="2"/>
  <line x1="123.39" y1="20.3553" x2="69.2823" y2="20.3553" stroke="black" style="stroke:black;stroke-opacity:1;" stroke-width="2"/>
  <line x1="1.5" y1="33" x2="1.5" y2="21" stroke="black" style="stroke:black;stroke-opacity:1;" stroke-width="3"/>
  <line x1="2.65088" y1="21.5" x2="25.5047" y2="21.5" stroke="black" style="stroke:black;stroke-opacity:1;" stroke-width="3"/>
  <line x1="7" y1="1.5" x2="123.39" y2="1.5" stroke="black" style="stroke:black;stroke-opacity:1;" stroke-width="3"/>
  <line y1="31.5" x2="125.278" y2="31.5" stroke="black" style="stroke:black;stroke-opacity:1;" stroke-width="3"/>
  <line x1="24.5" y1="32.6478" x2="24.5" y2="21.3753" stroke="black" style="stroke:black;stroke-opacity:1;" stroke-width="3"/>
</svg>
            </div>
        </div>

        <!-- Favorite Stations Card -->
        <div class="card">
            <div class="card-section">
                <div class="card-title">Favourite stations</div>
                <div class="card-description">Select up to 6 favourite stations — home, work, uni, cities you like to visit, etc. You will be able to plot routes between them on your watch.</div>
            </div>
            <div class="card-divider"></div>
            <div class="station-slots" id="stationSlots">
                <!-- Station slots will be rendered here -->
            </div>
        </div>

        <!-- Scheduled Routes Card -->
        <div class="card">
            <div class="card-section">
                <div class="card-title">Scheduled routes</div>
                <div class="card-description">Save your regular commutes here to always see relevant connections. If you open the app during a specified time slot, it will automatically show the specified route.</div>
            </div>
            <div class="card-divider"></div>
            <div class="schedule-list" id="scheduleList">
                <!-- Schedules will be rendered here -->
            </div>
            <button class="create-route-btn" onclick="openScheduleDrawer()">Create a route +</button>
        </div>

        <!-- About Card -->
        <div class="card">
            <div class="card-section">
                <div class="card-title">About</div>
                <div class="card-description">Commuter is made by <a href="https://werknaam.be" class="about-muted-link" target="_blank">Werknaam</a> in Leuven. Data is provided by <a href="https://docs.irail.be" class="about-muted-link" target="_blank">iRail</a>.</div>
                <a href="https://github.com/gbougakov/commuter-pebble" class="about-link" target="_blank">Source code on GitHub →</a>
            </div>
        </div>
    </div>

    <!-- Save Button (Fixed) -->
    <div class="save-button-container">
        <button class="save-button" onclick="saveConfig()">Save settings</button>
    </div>

    <!-- Station Search Drawer -->
    <div class="drawer-overlay" id="stationDrawerOverlay" onclick="closeStationDrawer()"></div>
    <div class="drawer" id="stationDrawer">
        <div class="drawer-content">
            <input type="text" class="search-box" id="stationSearch" placeholder="Search stations..." oninput="filterStations()">
            <div class="station-search-list" id="stationSearchList">
                <div class="loading">Loading stations...</div>
            </div>
        </div>
    </div>

    <!-- Schedule Editor Drawer -->
    <div class="drawer-overlay" id="scheduleDrawerOverlay" onclick="closeScheduleDrawer()"></div>
    <div class="drawer" id="scheduleDrawer">
        <div class="drawer-header">
            <div class="drawer-title" id="scheduleDrawerTitle">Create route</div>
        </div>
        <div class="drawer-content">
            <div class="form-group" id="formGroupFrom">
                <label class="form-label">From Station</label>
                <select id="editFromStation">
                    <option value="">Select station...</option>
                </select>
                <div class="form-error" id="errorFrom"></div>
            </div>

            <div class="form-group" id="formGroupTo">
                <label class="form-label">To Station</label>
                <select id="editToStation">
                    <option value="">Select station...</option>
                </select>
                <div class="form-error" id="errorTo"></div>
            </div>

            <div class="form-group" id="formGroupDays">
                <label class="form-label">Days</label>
                <div class="day-selector">
                    <button type="button" class="day-btn" data-day="1" onclick="toggleDay(1)">Mon</button>
                    <button type="button" class="day-btn" data-day="2" onclick="toggleDay(2)">Tue</button>
                    <button type="button" class="day-btn" data-day="3" onclick="toggleDay(3)">Wed</button>
                    <button type="button" class="day-btn" data-day="4" onclick="toggleDay(4)">Thu</button>
                    <button type="button" class="day-btn" data-day="5" onclick="toggleDay(5)">Fri</button>
                    <button type="button" class="day-btn" data-day="6" onclick="toggleDay(6)">Sat</button>
                    <button type="button" class="day-btn" data-day="0" onclick="toggleDay(0)">Sun</button>
                </div>
                <div class="form-error" id="errorDays"></div>
            </div>

            <div class="form-group" id="formGroupTime">
                <label class="form-label">Start Time</label>
                <input type="time" id="editStartTime" value="07:00">
            </div>

            <div class="form-group">
                <label class="form-label">End Time</label>
                <input type="time" id="editEndTime" value="09:00">
                <div class="form-error" id="errorTime"></div>
            </div>

            <div class="drawer-actions">
                <button class="btn-secondary" onclick="closeScheduleDrawer()">Cancel</button>
                <button class="btn-primary" onclick="saveSchedule()">Save route</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration state
        var stationCache = [];
        var favoriteStations = [];
        var smartSchedules = [];
        var maxStations = 6;

        // UI state
        var editingScheduleIndex = -1;
        var editingScheduleDays = [];
        var selectedStationSlot = -1;

        // Day names
        var dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

        // Initialize
        window.onload = function() {
            loadStations();
            loadConfig();
        };

        // Toast notification
        var toastTimer = null;
        function showToast(message) {
            var toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');

            if (toastTimer) clearTimeout(toastTimer);
            toastTimer = setTimeout(function() {
                toast.classList.remove('show');
            }, 3000);
        }

        // Load stations from API
        function loadStations() {
            var cached = localStorage.getItem('nmbs_station_cache');
            if (cached) {
                try {
                    stationCache = JSON.parse(cached);
                    console.log('Loaded ' + stationCache.length + ' cached stations');
                } catch (e) {
                    console.log('Error parsing cached stations');
                }
            }

            var xhr = new XMLHttpRequest();
            xhr.open('GET', 'https://api.irail.be/v1/stations?format=json', true);
            xhr.onload = function() {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    try {
                        var response = JSON.parse(xhr.responseText);
                        if (response.station && response.station.length > 0) {
                            stationCache = response.station.map(function(s) {
                                return {
                                    id: s.id,
                                    name: s.name,
                                    standardName: s.standardname
                                };
                            });
                            localStorage.setItem('nmbs_station_cache', JSON.stringify(stationCache));
                            console.log('Fetched ' + stationCache.length + ' stations');
                        }
                    } catch (e) {
                        console.log('Error parsing stations API');
                    }
                }
            };
            xhr.send();
        }

        // Load saved configuration
        function loadConfig() {
            try {
                var favJson = localStorage.getItem('nmbs_favorite_stations');
                if (favJson) {
                    favoriteStations = JSON.parse(favJson);
                }

                var schedJson = localStorage.getItem('nmbs_smart_schedules');
                if (schedJson) {
                    smartSchedules = JSON.parse(schedJson);
                }

                renderStationSlots();
                renderScheduleList();
            } catch (e) {
                console.log('Error loading config: ' + e.message);
            }
        }

        // Render station slots (numbered 1-6)
        function renderStationSlots() {
            var html = '';
            for (var i = 0; i < maxStations; i++) {
                var stationId = favoriteStations[i];
                var stationName = stationId ? getStationName(stationId) : 'Tap to add a station';
                var isPlaceholder = !stationId;

                html += '<div class="station-slot" onclick="openStationDrawer(' + i + ')">';
                html += '<div class="station-badge"><div class="station-badge-number">' + (i + 1) + '</div></div>';
                html += '<div class="station-name' + (isPlaceholder ? ' placeholder' : '') + '">' + stationName + '</div>';

                if (!isPlaceholder) {
                    html += '<div class="station-remove" onclick="removeStation(' + i + '); event.stopPropagation();">✗</div>';
                }

                html += '</div>';
            }
            document.getElementById('stationSlots').innerHTML = html;
        }

        // Open station drawer for slot
        function openStationDrawer(slotIndex) {
            selectedStationSlot = slotIndex;
            renderStationSearchList();

            document.getElementById('stationDrawerOverlay').classList.add('active');
            setTimeout(function() {
                document.getElementById('stationDrawer').classList.add('active');
            }, 10);
        }

        // Close station drawer
        function closeStationDrawer() {
            document.getElementById('stationDrawer').classList.remove('active');
            setTimeout(function() {
                document.getElementById('stationDrawerOverlay').classList.remove('active');
            }, 300);
        }

        // Render station search list
        function renderStationSearchList() {
            if (stationCache.length === 0) {
                document.getElementById('stationSearchList').innerHTML = '<div class="loading">Loading stations...</div>';
                return;
            }

            var html = '';
            var searchTerm = document.getElementById('stationSearch').value.toLowerCase();
            var hasResults = false;

            for (var i = 0; i < stationCache.length; i++) {
                var station = stationCache[i];
                var searchText = (station.name + ' ' + station.standardName).toLowerCase();

                if (searchTerm && searchText.indexOf(searchTerm) === -1) {
                    continue;
                }

                hasResults = true;
                var isAlreadyAdded = favoriteStations.indexOf(station.id) !== -1 && favoriteStations[selectedStationSlot] !== station.id;

                html += '<div class="station-search-item' + (isAlreadyAdded ? ' disabled' : '') + '" onclick="' + (isAlreadyAdded ? '' : 'selectStation(\'' + station.id + '\')') + '">';
                html += station.name;
                html += '</div>';
            }

            if (!hasResults) {
                html = '<div class="no-results">No stations found</div>';
            }

            document.getElementById('stationSearchList').innerHTML = html;
        }

        // Filter stations as user types
        function filterStations() {
            renderStationSearchList();
        }

        // Select station for current slot
        function selectStation(stationId) {
            favoriteStations[selectedStationSlot] = stationId;
            renderStationSlots();
            closeStationDrawer();
            document.getElementById('stationSearch').value = '';
        }

        // Remove station from slot
        function removeStation(slotIndex) {
            favoriteStations.splice(slotIndex, 1);
            renderStationSlots();
        }

        // Get station name by ID
        function getStationName(id) {
            for (var i = 0; i < stationCache.length; i++) {
                if (stationCache[i].id === id) {
                    return stationCache[i].name;
                }
            }
            return id;
        }

        // Render schedule list
        function renderScheduleList() {
            var scheduleListEl = document.getElementById('scheduleList');

            if (smartSchedules.length === 0) {
                // Hide the schedule list if there are no schedules
                scheduleListEl.style.display = 'none';
                return;
            }

            // Show the schedule list
            scheduleListEl.style.display = 'flex';

            var html = '';

            for (var i = 0; i < smartSchedules.length; i++) {
                var sched = smartSchedules[i];
                var fromName = getStationName(sched.fromId);
                var toName = getStationName(sched.toId);
                var daysText = getDaysText(sched.days);
                var timeText = sched.startTime + '–' + sched.endTime;

                html += '<div class="schedule-item" onclick="openScheduleDrawer(' + i + ')">';
                html += '<div class="schedule-info">';
                html += '<div class="schedule-meta">' + daysText + ' · ' + timeText + '</div>';
                html += '<div class="schedule-route">' + fromName + ' → ' + toName + '</div>';
                html += '</div>';
                html += '<div class="schedule-remove" onclick="removeSchedule(' + i + '); event.stopPropagation();">✗</div>';
                html += '</div>';
            }

            scheduleListEl.innerHTML = html;
        }

        // Get days text
        function getDaysText(days) {
            if (days.length === 7) return 'Every day';
            if (days.length === 5 && days.indexOf(0) === -1 && days.indexOf(6) === -1) return 'Weekdays';
            if (days.length === 2 && days.indexOf(0) !== -1 && days.indexOf(6) !== -1) return 'Weekends';

            var names = [];
            for (var i = 0; i < days.length; i++) {
                names.push(dayNames[days[i]]);
            }
            return names.join(', ');
        }

        // Open schedule drawer
        function openScheduleDrawer(scheduleIndex) {
            if (favoriteStations.length < 2) {
                showToast('Please add at least 2 stations first');
                return;
            }

            clearFormErrors();

            if (typeof scheduleIndex === 'number') {
                // Edit existing schedule
                editingScheduleIndex = scheduleIndex;
                var sched = smartSchedules[scheduleIndex];
                document.getElementById('scheduleDrawerTitle').textContent = 'Edit route';
                document.getElementById('editFromStation').value = sched.fromId;
                document.getElementById('editToStation').value = sched.toId;
                document.getElementById('editStartTime').value = sched.startTime;
                document.getElementById('editEndTime').value = sched.endTime;
                editingScheduleDays = sched.days.slice();
            } else {
                // Create new schedule
                editingScheduleIndex = -1;
                document.getElementById('scheduleDrawerTitle').textContent = 'Create route';
                document.getElementById('editFromStation').value = favoriteStations[0] || '';
                document.getElementById('editToStation').value = favoriteStations[1] || '';
                document.getElementById('editStartTime').value = '07:00';
                document.getElementById('editEndTime').value = '09:00';
                editingScheduleDays = [1, 2, 3, 4, 5]; // Weekdays
            }

            populateStationDropdowns();
            updateDayButtons();

            document.getElementById('scheduleDrawerOverlay').classList.add('active');
            setTimeout(function() {
                document.getElementById('scheduleDrawer').classList.add('active');
            }, 10);
        }

        // Close schedule drawer
        function closeScheduleDrawer() {
            document.getElementById('scheduleDrawer').classList.remove('active');
            setTimeout(function() {
                document.getElementById('scheduleDrawerOverlay').classList.remove('active');
            }, 300);
        }

        // Populate station dropdowns
        function populateStationDropdowns() {
            var fromSelect = document.getElementById('editFromStation');
            var toSelect = document.getElementById('editToStation');

            fromSelect.innerHTML = '<option value="">Select station...</option>';
            toSelect.innerHTML = '<option value="">Select station...</option>';

            for (var i = 0; i < favoriteStations.length; i++) {
                var stationId = favoriteStations[i];
                if (!stationId) continue;

                var stationName = getStationName(stationId);

                var option1 = document.createElement('option');
                option1.value = stationId;
                option1.textContent = stationName;
                fromSelect.appendChild(option1);

                var option2 = document.createElement('option');
                option2.value = stationId;
                option2.textContent = stationName;
                toSelect.appendChild(option2);
            }
        }

        // Toggle day selection
        function toggleDay(day) {
            var index = editingScheduleDays.indexOf(day);
            if (index !== -1) {
                editingScheduleDays.splice(index, 1);
            } else {
                editingScheduleDays.push(day);
            }
            updateDayButtons();
        }

        // Update day button visual state
        function updateDayButtons() {
            var buttons = document.querySelectorAll('.day-btn');
            for (var i = 0; i < buttons.length; i++) {
                var btn = buttons[i];
                var day = parseInt(btn.getAttribute('data-day'));
                if (editingScheduleDays.indexOf(day) !== -1) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            }
        }

        // Save schedule
        function saveSchedule() {
            clearFormErrors();

            var fromId = document.getElementById('editFromStation').value;
            var toId = document.getElementById('editToStation').value;
            var startTime = document.getElementById('editStartTime').value;
            var endTime = document.getElementById('editEndTime').value;

            var hasError = false;

            if (!fromId) {
                showFormError('From', 'Please select a departure station');
                hasError = true;
            }

            if (!toId) {
                showFormError('To', 'Please select an arrival station');
                hasError = true;
            }

            if (fromId && toId && fromId === toId) {
                showFormError('To', 'Stations must be different');
                hasError = true;
            }

            if (editingScheduleDays.length === 0) {
                showFormError('Days', 'Please select at least one day');
                hasError = true;
            }

            if (!startTime || !endTime) {
                showFormError('Time', 'Please enter both times');
                hasError = true;
            } else if (startTime >= endTime) {
                showFormError('Time', 'End time must be after start time');
                hasError = true;
            }

            if (hasError) return;

            var schedule = {
                id: editingScheduleIndex === -1 ? 'custom-' + Date.now() : smartSchedules[editingScheduleIndex].id,
                fromId: fromId,
                toId: toId,
                days: editingScheduleDays.slice().sort(function(a, b) { return a - b; }),
                startTime: startTime,
                endTime: endTime,
                enabled: true
            };

            if (editingScheduleIndex === -1) {
                smartSchedules.push(schedule);
            } else {
                smartSchedules[editingScheduleIndex] = schedule;
            }

            renderScheduleList();
            closeScheduleDrawer();
        }

        // Remove schedule
        function removeSchedule(index) {
            smartSchedules.splice(index, 1);
            renderScheduleList();
        }

        // Form error helpers
        function showFormError(fieldId, message) {
            var errorEl = document.getElementById('error' + fieldId);
            var formGroup = document.getElementById('formGroup' + fieldId);

            if (errorEl) {
                errorEl.textContent = message;
                errorEl.classList.add('show');
            }

            if (formGroup) {
                formGroup.classList.add('error');
            }
        }

        function clearFormErrors() {
            var errors = document.querySelectorAll('.form-error');
            for (var i = 0; i < errors.length; i++) {
                errors[i].classList.remove('show');
            }

            var formGroups = document.querySelectorAll('.form-group');
            for (var i = 0; i < formGroups.length; i++) {
                formGroups[i].classList.remove('error');
            }
        }

        // Get return URL parameter
        function getQueryParam(variable, defaultValue) {
            var query = location.search.substring(1);
            var vars = query.split('&');
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split('=');
                if (pair[0] === variable) {
                    return decodeURIComponent(pair[1]);
                }
            }
            return defaultValue || false;
        }

        // Save configuration
        function saveConfig() {
            // Filter out empty slots
            var validStations = favoriteStations.filter(function(id) { return id; });

            if (validStations.length === 0) {
                showToast('Please add at least one station');
                return;
            }

            var config = {
                favoriteStations: validStations,
                smartSchedules: smartSchedules
            };

            localStorage.setItem('nmbs_favorite_stations', JSON.stringify(validStations));
            localStorage.setItem('nmbs_smart_schedules', JSON.stringify(smartSchedules));

            var return_to = getQueryParam('return_to', 'pebblejs://close#');
            var configJson = JSON.stringify(config);
            document.location = return_to + encodeURIComponent(configJson);
        }
    </script>
</body>
</html>
