<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Commuter Configuration</title>
    <!-- HTML in your document's head -->
    <link rel="preconnect" href="https://rsms.me/">
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">


    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* CSS */
        :root {
            font-family: Inter, sans-serif;
            font-feature-settings: 'liga' 1, 'calt' 1; /* fix for Chrome */

            /* Light theme colors */
            --bg-primary: #e8e8e8;
            --bg-card: white;
            --bg-drawer: white;
            --bg-text-field: #eee;
            --text-primary: black;
            --text-secondary: rgba(0, 0, 0, 0.35);
            --text-placeholder: rgba(0, 0, 0, 0.25);
            --divider: rgba(0, 0, 0, 0.1);
            --border: rgba(0, 0, 0, 0.15);
            --badge-bg: rgba(0, 0, 0, 0.1);
            --overlay: rgba(0, 0, 0, 0.4);
            --search-item-hover: rgba(0, 85, 255, 0.08);
            --drawer-handle: rgba(0, 0, 0, 0.15);

            /* Brand colors (same in both themes) */
            --blue: #0055ff;
            --green: #52d694;
            --red: #ff0707;
            --blue-muted: #0055ffa8;
        }

        /* Dark theme - OLED Black */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-primary: #000000;
                --bg-card: #232325;
                --bg-drawer: #232325;
                --bg-text-field: #333;
                --text-primary: white;
                --text-secondary: rgba(255, 255, 255, 0.6);
                --text-placeholder: rgba(255, 255, 255, 0.4);
                --divider: rgba(255, 255, 255, 0.12);
                --border: rgba(255, 255, 255, 0.2);
                --badge-bg: rgba(255, 255, 255, 0.12);
                --overlay: rgba(0, 0, 0, 0.85);
                --search-item-hover: rgba(0, 85, 255, 0.25);
                --drawer-handle: rgba(255, 255, 255, 0.3);
                --blue-muted: #0055ffdd;
            }
        }

        @supports (font-variation-settings: normal) {
            :root { font-family: InterVariable, sans-serif; }
        }

        body {
            background: var(--bg-primary);
            padding: 0 0 100px 0;
            margin: 0;
            font-size: 16px;
            line-height: 1.2;
            -webkit-font-smoothing: antialiased;
        }

        button {
            font-family: inherit;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Header Card */
        .header-card {
            background: #0055ff;
            border-radius: 20px;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-right: 0;
        }

        .header-title {
            font-size: 32px;
            font-weight: 600;
            color: white;
            line-height: 32px;
        }

        .header-icon {
            width: 123px;
            height: 32px;
        }

        /* White Cards */
        .card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-description {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-secondary);
            line-height: 1.2;
        }

        .card-divider {
            height: 1px;
            background: var(--divider);
            width: 100%;
        }

        /* Station List */
        .station-slots {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .station-slot {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .station-slot:active {
            opacity: 0.7;
        }

        .station-badge {
            background: var(--badge-bg);
            width: 19px;
            height: 19px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .station-badge-number {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 16px;
            font-feature-settings: "tnum";
        }

        .station-name {
            flex: 1;
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
            line-height: 1.2;
        }

        .station-name.placeholder {
            color: var(--text-placeholder);
        }

        .station-remove {
            font-size: 16px;
            font-weight: 500;
            color: var(--red);
            cursor: pointer;
            padding: 0 5px;
        }

        /* Schedule List */
        .schedule-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .schedule-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .schedule-item:active {
            opacity: 0.7;
        }

        .schedule-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex: 1;
        }

        .schedule-meta {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-secondary);
            line-height: 1.2;
        }

        .schedule-route {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.2;
        }

        .schedule-remove {
            font-size: 16px;
            font-weight: 500;
            color: var(--red);
            cursor: pointer;
            padding: 0 5px;
        }

        .create-route-btn {
            font-size: 16px;
            font-weight: 500;
            color: var(--blue);
            background: none;
            border: none;
            cursor: pointer;
            text-align: left;
            padding: 0;
        }

        .create-route-btn:active {
            opacity: 0.7;
        }

        /* About Section */
        .about-link {
            font-size: 16px;
            font-weight: 500;
            color: var(--blue);
            text-decoration: none;
            display: inline-block;
        }

        .about-muted-link {
            font-size: 16px;
            font-weight: 500;
            color: var(--blue-muted);
            text-decoration: none;
            display: inline-block;
        }

        /* Language Selector */
        .language-selector {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .language-option {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            padding: 8px 0;
            transition: opacity 0.2s;
        }

        .language-option:active {
            opacity: 0.7;
        }

        .language-radio {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .language-radio.selected {
            border-color: var(--blue);
        }

        .language-radio-inner {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--blue);
            display: none;
        }

        .language-radio.selected .language-radio-inner {
            display: block;
        }

        .language-label {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
            line-height: 1.2;
        }

        /* Save Button (Fixed) */
        .save-button-container {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 500px;
            padding: 0px;
            pointer-events: none;
        }

        .save-button {
            background: var(--green);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 20px;
            font-size: 24px;
            font-weight: 600;
            line-height: 24px;
            width: 100%;
            cursor: pointer;
            pointer-events: all;
            transition: transform 0.2s;
        }

        .save-button:active {
            transform: scale(0.98);
        }

        /* Bottom Sheet Drawer */
        .drawer-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--overlay);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .drawer-overlay.active {
            display: block;
            opacity: 1;
        }

        .drawer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-drawer);
            border-radius: 20px 20px 0 0;
            max-height: 80vh;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 1001;
            display: flex;
            flex-direction: column;
        }

        .drawer.active {
            transform: translateY(0);
        }

        .drawer-header {
            padding: 12px 20px;
            border-bottom: 1px solid var(--divider);
            flex-shrink: 0;
        }

        .drawer-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .drawer-content {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        /* Station Search Drawer */
        .search-box {
            width: 100%;
            padding: 12px 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-family: 'Inter', sans-serif;
            margin-bottom: 16px;
            background: var(--bg-text-field);
            color: var(--text-primary);
        }

        .search-box:focus {
            outline: none;
            border-color: var(--blue);
        }

        .station-search-list {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .station-search-item {
            padding: 16px 0px;
            border-bottom: 1px solid var(--divider);
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
            transition: background 0.15s;
        }

        .station-search-item:active {
            background: var(--search-item-hover);
        }

        .station-search-item.disabled {
            color: var(--text-placeholder);
            cursor: not-allowed;
        }

        .station-search-item.disabled:active {
            background: transparent;
        }

        .no-results {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
            font-size: 15px;
        }

        /* Schedule Form Drawer */
        .form-section {
            margin-bottom: 20px;
        }

        .form-section-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        /* Route Selector */
        .route-selector {
            background: var(--bg-text-field);
            border-radius: 12px;
            padding-left: 12px;
            padding-right: 12px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .route-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0;
            padding: 20px 1px;
        }

        .route-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
            border: 2px solid var(--divider);
        }

        .route-line {
            width: 1.5px;
            height: 36px;
            background: var(--divider);
        }

        .route-inputs {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .route-select {
            width: 100%;
            padding: 0;
            border: none;
            background: transparent;
            font-size: 16px;
            font-weight: 500;
            font-family: 'Inter', sans-serif;
            color: var(--text-primary);
            cursor: pointer;
        }

        .route-select option {
            background: var(--bg-drawer);
            color: var(--text-primary);
        }

        .route-select:focus {
            outline: none;
        }

        .route-divider {
            height: 1px;
            background: var(--divider);
            width: 100%;
        }

        /* Day Selector - Circular */
        .day-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .day-btn-circle {
            flex: 1;
            min-width: 39px;
            aspect-ratio: 1;
            padding: 10px;
            border: none;
            background: var(--bg-text-field);
            border-radius: 50%;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-placeholder);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .day-btn-circle.active {
            background: var(--blue);
            color: white;
        }

        .day-btn-circle:active {
            transform: scale(0.95);
        }

        /* Time Range */
        .time-range {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .time-input {
            flex: 1;
            padding: 12px 16px;
            border: none;
            background: var(--bg-text-field);
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            font-family: 'Inter', sans-serif;
            color: var(--text-primary);
            text-align: center;
        }

        .time-input:focus {
            outline: none;
        }

        .time-arrow {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-placeholder);
        }

        /* Form Errors */
        .form-error {
            color: var(--red);
            font-size: 13px;
            margin-top: 6px;
            display: none;
        }

        .form-error.show {
            display: block;
        }

        .form-section.error .route-selector {
            border: 1px solid var(--red);
        }

        /* Schedule Save Button */
        .schedule-save-btn {
            width: 100%;
            padding: 16px 20px;
            border: none;
            background: var(--green);
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .schedule-save-btn:active {
            transform: scale(0.98);
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 14px 24px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 500;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease;
            max-width: 90%;
            text-align: center;
        }

        .toast.show {
            opacity: 1;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
            font-size: 15px;
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Main Container -->
    <div class="container">
        <!-- Header -->
        <div class="header-card">
            <div class="header-title">Commuter</div>
            <div class="header-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="124" height="33" viewBox="0 0 124 33" fill="none">
  <path d="M1.55859 21.4456L8.0387 1.51306H129.402V31.4528H1.55859V21.4456Z" fill="white" style="fill:white;fill-opacity:1;"/>
  <line x1="1.57693" y1="21.3974" x2="8.53214" y2="0.52573" stroke="black" style="stroke:black;stroke-opacity:1;" stroke-width="3"/>
  <line x1="24.5769" y1="21.3974" x2="31.5321" y2="0.52573" stroke="black" style="stroke:black;stroke-opacity:1;" stroke-width="3"/>
  <line x1="30.6006" y1="19.8839" x2="35.3428" y2="5.65327" stroke="black" style="stroke:black;stroke-opacity:1;" stroke-width="2"/>
  <line x1="40.4822" y1="20.5846" x2="40.4822" y2="5.5846" stroke="black" style="stroke:black;stroke-opacity:1;" stroke-width="2"/>
  <line x1="70.2822" y1="20.9694" x2="70.2822" y2="5.96936" stroke="black" style="stroke:black;stroke-opacity:1;" stroke-width="2"/>
  <line x1="45.3301" y1="32.6478" x2="45.3301" y2="5.17861" stroke="black" style="stroke:black;stroke-opacity:1;" stroke-width="2"/>
  <line x1="65.6775" y1="32.6478" x2="65.6775" y2="5.17861" stroke="black" style="stroke:black;stroke-opacity:1;" stroke-width="2"/>
  <line x1="55.4001" y1="32.6478" x2="55.4001" y2="5.17861" stroke="black" style="stroke:black;stroke-opacity:1;" stroke-width="2"/>
  <line x1="41.4822" y1="6.17859" x2="34.3882" y2="6.17859" stroke="black" style="stroke:black;stroke-opacity:1;" stroke-width="2"/>
  <line x1="123.39" y1="6.17859" x2="69.2823" y2="6.17859" stroke="black" style="stroke:black;stroke-opacity:1;" stroke-width="2"/>
  <line x1="65.7988" y1="6.17859" x2="46.33" y2="6.17859" stroke="black" style="stroke:black;stroke-opacity:1;" stroke-width="2"/>
  <line x1="41.4822" y1="20.3553" x2="29.7135" y2="20.3553" stroke="black" style="stroke:black;stroke-opacity:1;" stroke-width="2"/>
  <line x1="123.39" y1="20.3553" x2="69.2823" y2="20.3553" stroke="black" style="stroke:black;stroke-opacity:1;" stroke-width="2"/>
  <line x1="1.5" y1="33" x2="1.5" y2="21" stroke="black" style="stroke:black;stroke-opacity:1;" stroke-width="3"/>
  <line x1="2.65088" y1="21.5" x2="25.5047" y2="21.5" stroke="black" style="stroke:black;stroke-opacity:1;" stroke-width="3"/>
  <line x1="7" y1="1.5" x2="123.39" y2="1.5" stroke="black" style="stroke:black;stroke-opacity:1;" stroke-width="3"/>
  <line y1="31.5" x2="125.278" y2="31.5" stroke="black" style="stroke:black;stroke-opacity:1;" stroke-width="3"/>
  <line x1="24.5" y1="32.6478" x2="24.5" y2="21.3753" stroke="black" style="stroke:black;stroke-opacity:1;" stroke-width="3"/>
</svg>
            </div>
        </div>

        <!-- Favorite Stations Card -->
        <div class="card">
            <div class="card-section">
                <div class="card-title">Favourite stations</div>
                <div class="card-description">Select up to 6 favourite stations — home, work, uni, cities you like to visit, etc. You will be able to plot routes between them on your watch.</div>
            </div>
            <div class="card-divider"></div>
            <div class="station-slots" id="stationSlots">
                <!-- Station slots will be rendered here -->
            </div>
        </div>

        <!-- Scheduled Routes Card -->
        <div class="card">
            <div class="card-section">
                <div class="card-title">Scheduled routes</div>
                <div class="card-description">Save your regular commutes here to always see relevant connections. If you open the app during a specified time slot, it will automatically show the specified route.</div>
            </div>
            <div class="card-divider"></div>
            <div class="schedule-list" id="scheduleList">
                <!-- Schedules will be rendered here -->
            </div>
            <button class="create-route-btn" onclick="openScheduleDrawer()">Create a route +</button>
        </div>

        <!-- Language Settings Card -->
        <div class="card">
            <div class="card-section">
                <div class="card-title">Language</div>
                <div class="card-description">Choose the language for station names. This affects how station names are displayed on your watch.</div>
            </div>
            <div class="card-divider"></div>
            <div class="language-selector" id="languageSelector">
                <!-- Language options will be rendered here -->
            </div>
        </div>

        <!-- About Card -->
        <div class="card">
            <div class="card-section">
                <div class="card-title">About</div>
                <div class="card-description">Commuter is made by <a href="x-safari-https://werknaam.be" class="about-muted-link" target="_blank">Werknaam</a> in Leuven. Data is provided by <a href="x-safari-https://docs.irail.be" class="about-muted-link" target="_blank">iRail</a>.</div>
                <a href="x-safari-https://github.com/gbougakov/commuter-pebble" class="about-link" target="_blank">Source code on GitHub →</a>
            </div>
        </div>
    </div>

    <!-- Save Button (Fixed) -->
    <div class="save-button-container">
        <button class="save-button" onclick="saveConfig()">Save settings</button>
    </div>

    <!-- Station Search Drawer -->
    <div class="drawer-overlay" id="stationDrawerOverlay" onclick="closeStationDrawer()"></div>
    <div class="drawer" id="stationDrawer">
        <div class="drawer-content">
            <input type="text" class="search-box" id="stationSearch" placeholder="Search stations..." oninput="filterStations()">
            <div class="station-search-list" id="stationSearchList">
                <div class="loading">Loading stations...</div>
            </div>
        </div>
    </div>

    <!-- Schedule Editor Drawer -->
    <div class="drawer-overlay" id="scheduleDrawerOverlay" onclick="closeScheduleDrawer()"></div>
    <div class="drawer" id="scheduleDrawer">
        <div class="drawer-content">
            <!-- Route Section -->
            <div class="form-section">
                <div class="form-section-title">Route</div>
                <div class="route-selector" id="formGroupRoute">
                    <div class="route-indicator">
                        <div class="route-dot route-dot-start"></div>
                        <div class="route-line"></div>
                        <div class="route-dot route-dot-end"></div>
                    </div>
                    <div class="route-inputs">
                        <select id="editFromStation" class="route-select">
                            <option value="">From</option>
                        </select>
                        <div class="route-divider"></div>
                        <select id="editToStation" class="route-select">
                            <option value="">To</option>
                        </select>
                    </div>
                </div>
                <div class="form-error" id="errorRoute"></div>
            </div>

            <!-- Schedule Section -->
            <div class="form-section">
                <div class="form-section-title">Schedule</div>

                <!-- Days -->
                <div class="day-selector" id="formGroupDays">
                    <button type="button" class="day-btn-circle" data-day="1" onclick="toggleDay(1)">M</button>
                    <button type="button" class="day-btn-circle" data-day="2" onclick="toggleDay(2)">T</button>
                    <button type="button" class="day-btn-circle" data-day="3" onclick="toggleDay(3)">W</button>
                    <button type="button" class="day-btn-circle" data-day="4" onclick="toggleDay(4)">T</button>
                    <button type="button" class="day-btn-circle" data-day="5" onclick="toggleDay(5)">F</button>
                    <button type="button" class="day-btn-circle" data-day="6" onclick="toggleDay(6)">S</button>
                    <button type="button" class="day-btn-circle" data-day="0" onclick="toggleDay(0)">S</button>
                </div>
                <div class="form-error" id="errorDays"></div>

                <!-- Time Range -->
                <div class="time-range" id="formGroupTime">
                    <input type="time" id="editStartTime" class="time-input" value="07:00">
                    <div class="time-arrow">→</div>
                    <input type="time" id="editEndTime" class="time-input" value="09:00">
                </div>
                <div class="form-error" id="errorTime"></div>
            </div>

            <!-- Save Button -->
            <button class="schedule-save-btn" onclick="saveSchedule()">Add route</button>
        </div>
    </div>

    <script>
        // Configuration state
        var stationCache = [];
        var favoriteStations = [];
        var smartSchedules = [];
        var maxStations = 6;
        var selectedLanguage = 'en';

        // UI state
        var editingScheduleIndex = -1;
        var editingScheduleDays = [];
        var selectedStationSlot = -1;

        // Day names
        var dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

        // Supported languages
        var languages = [
            { code: 'en', name: 'English' },
            { code: 'nl', name: 'Nederlands' },
            { code: 'fr', name: 'Français' },
            { code: 'de', name: 'Deutsch' }
        ];

        // Initialize
        window.onload = function() {
            loadStations();
            loadConfig();
            renderLanguageSelector();
        };

        // Toast notification
        var toastTimer = null;
        function showToast(message) {
            var toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');

            if (toastTimer) clearTimeout(toastTimer);
            toastTimer = setTimeout(function() {
                toast.classList.remove('show');
            }, 3000);
        }

        // Load stations from API
        function loadStations() {
            var cached = localStorage.getItem('nmbs_station_cache');
            if (cached) {
                try {
                    stationCache = JSON.parse(cached);
                    console.log('Loaded ' + stationCache.length + ' cached stations');
                } catch (e) {
                    console.log('Error parsing cached stations');
                }
            }

            var xhr = new XMLHttpRequest();
            var url = 'https://api.irail.be/v1/stations?format=json&lang=' + selectedLanguage;
            xhr.open('GET', url, true);
            xhr.onload = function() {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    try {
                        var response = JSON.parse(xhr.responseText);
                        if (response.station && response.station.length > 0) {
                            stationCache = response.station.map(function(s) {
                                return {
                                    id: s.id,
                                    name: s.name
                                };
                            });
                            localStorage.setItem('nmbs_station_cache', JSON.stringify(stationCache));
                            console.log('Fetched ' + stationCache.length + ' stations');
                        }
                    } catch (e) {
                        console.log('Error parsing stations API');
                    }
                }
            };
            xhr.send();
        }

        // Load saved configuration
        function loadConfig() {
            try {
                var favJson = localStorage.getItem('nmbs_favorite_stations');
                if (favJson) {
                    favoriteStations = JSON.parse(favJson);
                }

                var schedJson = localStorage.getItem('nmbs_smart_schedules');
                if (schedJson) {
                    smartSchedules = JSON.parse(schedJson);
                }

                var langCode = localStorage.getItem('nmbs_language');
                if (langCode) {
                    selectedLanguage = langCode;
                }

                renderStationSlots();
                renderScheduleList();
            } catch (e) {
                console.log('Error loading config: ' + e.message);
            }
        }

        // Render station slots (numbered 1-6)
        function renderStationSlots() {
            var html = '';
            for (var i = 0; i < maxStations; i++) {
                var stationId = favoriteStations[i];
                var stationName = stationId ? getStationName(stationId) : 'Tap to add a station';
                var isPlaceholder = !stationId;

                html += '<div class="station-slot" onclick="openStationDrawer(' + i + ')">';
                html += '<div class="station-badge"><div class="station-badge-number">' + (i + 1) + '</div></div>';
                html += '<div class="station-name' + (isPlaceholder ? ' placeholder' : '') + '">' + stationName + '</div>';

                if (!isPlaceholder) {
                    html += '<div class="station-remove" onclick="(function(e) { removeStation(' + i + '); e.stopPropagation(); })(event);">✗</div>';
                }

                html += '</div>';
            }
            document.getElementById('stationSlots').innerHTML = html;
        }

        // Open station drawer for slot
        function openStationDrawer(slotIndex) {
            selectedStationSlot = slotIndex;
            renderStationSearchList();

            document.getElementById('stationDrawerOverlay').classList.add('active');
            setTimeout(function() {
                document.getElementById('stationDrawer').classList.add('active');
            }, 10);
        }

        // Close station drawer
        function closeStationDrawer() {
            document.getElementById('stationDrawer').classList.remove('active');
            setTimeout(function() {
                document.getElementById('stationDrawerOverlay').classList.remove('active');
            }, 300);
        }

        // Render station search list
        function renderStationSearchList() {
            if (stationCache.length === 0) {
                document.getElementById('stationSearchList').innerHTML = '<div class="loading">Loading stations...</div>';
                return;
            }

            var html = '';
            var searchTerm = document.getElementById('stationSearch').value.toLowerCase();
            var hasResults = false;

            for (var i = 0; i < stationCache.length; i++) {
                var station = stationCache[i];
                var searchText = station.name.toLowerCase();

                if (searchTerm && searchText.indexOf(searchTerm) === -1) {
                    continue;
                }

                hasResults = true;
                var isAlreadyAdded = favoriteStations.indexOf(station.id) !== -1 && favoriteStations[selectedStationSlot] !== station.id;

                html += '<div class="station-search-item' + (isAlreadyAdded ? ' disabled' : '') + '" onclick="' + (isAlreadyAdded ? '' : 'selectStation(\'' + station.id + '\')') + '">';
                html += station.name;
                html += '</div>';
            }

            if (!hasResults) {
                html = '<div class="no-results">No stations found</div>';
            }

            document.getElementById('stationSearchList').innerHTML = html;
        }

        // Filter stations as user types
        function filterStations() {
            renderStationSearchList();
        }

        // Select station for current slot
        function selectStation(stationId) {
            favoriteStations[selectedStationSlot] = stationId;
            renderStationSlots();
            closeStationDrawer();
            document.getElementById('stationSearch').value = '';
        }

        // Remove station from slot
        function removeStation(slotIndex) {
            favoriteStations.splice(slotIndex, 1);
            renderStationSlots();
        }

        // Get station name by ID
        function getStationName(id) {
            for (var i = 0; i < stationCache.length; i++) {
                if (stationCache[i].id === id) {
                    return stationCache[i].name;
                }
            }
            return id;
        }

        // Render schedule list
        function renderScheduleList() {
            var scheduleListEl = document.getElementById('scheduleList');

            if (smartSchedules.length === 0) {
                // Hide the schedule list if there are no schedules
                scheduleListEl.style.display = 'none';
                return;
            }

            // Show the schedule list
            scheduleListEl.style.display = 'flex';

            var html = '';

            for (var i = 0; i < smartSchedules.length; i++) {
                var sched = smartSchedules[i];
                var fromName = getStationName(sched.fromId);
                var toName = getStationName(sched.toId);
                var daysText = getDaysText(sched.days);
                var timeText = sched.startTime + '–' + sched.endTime;

                html += '<div class="schedule-item" onclick="openScheduleDrawer(' + i + ')">';
                html += '<div class="schedule-info">';
                html += '<div class="schedule-meta">' + daysText + ' · ' + timeText + '</div>';
                html += '<div class="schedule-route">' + fromName + ' → ' + toName + '</div>';
                html += '</div>';
                html += '<div class="schedule-remove" onclick="(function(e) { removeSchedule(' + i + '); e.stopPropagation(); })(event);">✗</div>';
                html += '</div>';
            }

            scheduleListEl.innerHTML = html;
        }

        // Get days text
        function getDaysText(days) {
            if (days.length === 7) return 'Every day';
            if (days.length === 5 && days.indexOf(0) === -1 && days.indexOf(6) === -1) return 'Weekdays';
            if (days.length === 2 && days.indexOf(0) !== -1 && days.indexOf(6) !== -1) return 'Weekends';

            var names = [];
            for (var i = 0; i < days.length; i++) {
                names.push(dayNames[days[i]]);
            }
            return names.join(', ');
        }

        // Open schedule drawer
        function openScheduleDrawer(scheduleIndex) {
            if (favoriteStations.length < 2) {
                showToast('Please add at least 2 stations first');
                return;
            }

            clearFormErrors();

            if (typeof scheduleIndex === 'number') {
                // Edit existing schedule
                editingScheduleIndex = scheduleIndex;
                var sched = smartSchedules[scheduleIndex];
                document.getElementById('editFromStation').value = sched.fromId;
                document.getElementById('editToStation').value = sched.toId;
                document.getElementById('editStartTime').value = sched.startTime;
                document.getElementById('editEndTime').value = sched.endTime;
                editingScheduleDays = sched.days.slice();
            } else {
                // Create new schedule
                editingScheduleIndex = -1;
                document.getElementById('editFromStation').value = favoriteStations[0] || '';
                document.getElementById('editToStation').value = favoriteStations[1] || '';
                document.getElementById('editStartTime').value = '07:00';
                document.getElementById('editEndTime').value = '09:00';
                editingScheduleDays = [1, 2, 3, 4, 5]; // Weekdays
            }

            populateStationDropdowns();
            updateDayButtons();

            document.getElementById('scheduleDrawerOverlay').classList.add('active');
            setTimeout(function() {
                document.getElementById('scheduleDrawer').classList.add('active');
            }, 10);
        }

        // Close schedule drawer
        function closeScheduleDrawer() {
            document.getElementById('scheduleDrawer').classList.remove('active');
            setTimeout(function() {
                document.getElementById('scheduleDrawerOverlay').classList.remove('active');
            }, 300);
        }

        // Populate station dropdowns
        function populateStationDropdowns() {
            var fromSelect = document.getElementById('editFromStation');
            var toSelect = document.getElementById('editToStation');

            fromSelect.innerHTML = '<option value="">From</option>';
            toSelect.innerHTML = '<option value="">To</option>';

            for (var i = 0; i < favoriteStations.length; i++) {
                var stationId = favoriteStations[i];
                if (!stationId) continue;

                var stationName = getStationName(stationId);

                var option1 = document.createElement('option');
                option1.value = stationId;
                option1.textContent = stationName;
                fromSelect.appendChild(option1);

                var option2 = document.createElement('option');
                option2.value = stationId;
                option2.textContent = stationName;
                toSelect.appendChild(option2);
            }
        }

        // Toggle day selection
        function toggleDay(day) {
            var index = editingScheduleDays.indexOf(day);
            if (index !== -1) {
                editingScheduleDays.splice(index, 1);
            } else {
                editingScheduleDays.push(day);
            }
            updateDayButtons();
        }

        // Update day button visual state
        function updateDayButtons() {
            var buttons = document.querySelectorAll('.day-btn-circle');
            for (var i = 0; i < buttons.length; i++) {
                var btn = buttons[i];
                var day = parseInt(btn.getAttribute('data-day'));
                if (editingScheduleDays.indexOf(day) !== -1) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            }
        }

        // Save schedule
        function saveSchedule() {
            clearFormErrors();

            var fromId = document.getElementById('editFromStation').value;
            var toId = document.getElementById('editToStation').value;
            var startTime = document.getElementById('editStartTime').value;
            var endTime = document.getElementById('editEndTime').value;

            var hasError = false;

            if (!fromId || !toId) {
                showFormError('Route', 'Please select both stations');
                hasError = true;
            } else if (fromId === toId) {
                showFormError('Route', 'Stations must be different');
                hasError = true;
            }

            if (editingScheduleDays.length === 0) {
                showFormError('Days', 'Please select at least one day');
                hasError = true;
            }

            if (!startTime || !endTime) {
                showFormError('Time', 'Please enter both times');
                hasError = true;
            } else if (startTime >= endTime) {
                showFormError('Time', 'End time must be after start time');
                hasError = true;
            }

            if (hasError) return;

            var schedule = {
                id: editingScheduleIndex === -1 ? 'custom-' + Date.now() : smartSchedules[editingScheduleIndex].id,
                fromId: fromId,
                toId: toId,
                days: editingScheduleDays.slice().sort(function(a, b) { return a - b; }),
                startTime: startTime,
                endTime: endTime,
                enabled: true
            };

            if (editingScheduleIndex === -1) {
                smartSchedules.push(schedule);
            } else {
                smartSchedules[editingScheduleIndex] = schedule;
            }

            renderScheduleList();
            closeScheduleDrawer();
        }

        // Remove schedule
        function removeSchedule(index) {
            smartSchedules.splice(index, 1);
            renderScheduleList();
        }

        // Form error helpers
        function showFormError(fieldId, message) {
            var errorEl = document.getElementById('error' + fieldId);
            var formSection = document.getElementById('formGroup' + fieldId);

            if (errorEl) {
                errorEl.textContent = message;
                errorEl.classList.add('show');
            }

            if (formSection) {
                formSection.classList.add('error');
            }
        }

        function clearFormErrors() {
            var errors = document.querySelectorAll('.form-error');
            for (var i = 0; i < errors.length; i++) {
                errors[i].classList.remove('show');
            }

            var formSections = document.querySelectorAll('.form-section, .route-selector, .day-selector, .time-range');
            for (var i = 0; i < formSections.length; i++) {
                formSections[i].classList.remove('error');
            }
        }

        // Get return URL parameter
        function getQueryParam(variable, defaultValue) {
            var query = location.search.substring(1);
            var vars = query.split('&');
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split('=');
                if (pair[0] === variable) {
                    return decodeURIComponent(pair[1]);
                }
            }
            return defaultValue || false;
        }

        // Render language selector
        function renderLanguageSelector() {
            var container = document.getElementById('languageSelector');
            var html = '';

            for (var i = 0; i < languages.length; i++) {
                var lang = languages[i];
                var isSelected = lang.code === selectedLanguage;

                html += '<div class="language-option" onclick="selectLanguage(\'' + lang.code + '\')">';
                html += '  <div class="language-radio' + (isSelected ? ' selected' : '') + '">';
                html += '    <div class="language-radio-inner"></div>';
                html += '  </div>';
                html += '  <div class="language-label">' + lang.name + '</div>';
                html += '</div>';
            }

            container.innerHTML = html;
        }

        // Select a language
        function selectLanguage(code) {
            selectedLanguage = code;
            localStorage.setItem('nmbs_language', code);
            renderLanguageSelector();

            // Clear station cache to force refresh with new language
            localStorage.removeItem('nmbs_station_cache');
            stationCache = [];
            loadStations();

            showToast('Language changed to ' + getLanguageName(code));
        }

        // Get language name by code
        function getLanguageName(code) {
            for (var i = 0; i < languages.length; i++) {
                if (languages[i].code === code) {
                    return languages[i].name;
                }
            }
            return code;
        }

        // Save configuration
        function saveConfig() {
            // Filter out empty slots
            var validStations = favoriteStations.filter(function(id) { return id; });

            if (validStations.length === 0) {
                showToast('Please add at least one station');
                return;
            }

            var config = {
                favoriteStations: validStations,
                smartSchedules: smartSchedules,
                language: selectedLanguage
            };

            localStorage.setItem('nmbs_favorite_stations', JSON.stringify(validStations));
            localStorage.setItem('nmbs_smart_schedules', JSON.stringify(smartSchedules));
            localStorage.setItem('nmbs_language', selectedLanguage);

            var return_to = getQueryParam('return_to', 'pebblejs://close#');
            var configJson = JSON.stringify(config);
            document.location = return_to + encodeURIComponent(configJson);
        }
    </script>
</body>
</html>
